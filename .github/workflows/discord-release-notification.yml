name: Discord Release Notification

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag de la release (ex: v1.0.0)'
        required: true
        default: 'v1.0.0'

jobs:
  notify-discord:
    name: Notify Discord
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Extract Version
        id: version
        run: |
          # Utiliser le tag de l'√©v√©nement release ou l'input manuel
          if [ "${{ github.event_name }}" == "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
          else
            VERSION="${{ github.event.inputs.tag_name }}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "version_number=${VERSION#v}" >> $GITHUB_OUTPUT

      - name: Extract Changelog
        id: changelog
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          # Extraire la section du CHANGELOG pour cette version
          # Supporte X.Y.Z et X.Y.Z-suffix (beta, rc, etc.)
          awk -v ver="${VERSION#v}" '
            /^## \[/ {
              # Extraire la version entre crochets (avec support des suffixes)
              match($0, /\[([0-9]+\.[0-9]+\.[0-9]+[^\]]*)\]/, arr)
              if (arr[1] == ver) {
                started = 1
                next
              } else if (started) {
                exit
              }
            }
            started { print }
          ' CHANGELOG.md > changelog_extract.txt
          
          # V√©rifier si le changelog a √©t√© extrait
          if [ ! -s changelog_extract.txt ]; then
            echo "‚ö†Ô∏è ATTENTION: Changelog vide pour $VERSION" >&2
            echo "üìù Contenu disponible dans les prochaines releases." > changelog_extract.txt
          fi
          
          # Limiter √† 1000 caract√®res avec indicateur de troncature
          CHANGELOG_SIZE=$(wc -c < changelog_extract.txt)
          if [ $CHANGELOG_SIZE -gt 1000 ]; then
            head -c 997 changelog_extract.txt > changelog_short.txt
            echo "..." >> changelog_short.txt
            echo "truncated=true" >> $GITHUB_OUTPUT
          else
            cp changelog_extract.txt changelog_short.txt
            echo "truncated=false" >> $GITHUB_OUTPUT
          fi

      - name: Extract Summary
        id: summary
        run: |
          # Extraire les 3 premi√®res cat√©gories principales (max 500 caract√®res)
          SUMMARY=$(awk '
            /^### / {
              if (count++ < 3) {
                gsub(/^### /, "");
                print "‚Ä¢ " $0
              }
            }
          ' changelog_extract.txt | head -c 500)
          
          if [ -z "$SUMMARY" ]; then
            SUMMARY="‚ú® Nouvelles fonctionnalit√©s et am√©liorations"
          fi
          
          # √âchapper pour utilisation dans jq
          echo "$SUMMARY" > summary.txt

      - name: Fetch Release Asset
        id: asset
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          VERSION_NUMBER="${{ steps.version.outputs.version_number }}"
          REPO="${{ github.repository }}"
          
          echo "üîç Recherche des assets pour $VERSION..."
          
          RESPONSE=$(curl -s \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            "https://api.github.com/repos/$REPO/releases/tags/$VERSION")
          
          # Chercher l'installateur .exe
          ASSET_URL=$(echo "$RESPONSE" | jq -r '.assets[]? | select(.name | endswith(".exe")) | .browser_download_url' | head -n 1)
          ASSET_NAME=$(echo "$RESPONSE" | jq -r '.assets[]? | select(.name | endswith(".exe")) | .name' | head -n 1)
          
          # Fallback si l'asset n'existe pas encore
          if [ -z "$ASSET_URL" ] || [ "$ASSET_URL" = "null" ]; then
            echo "‚ö†Ô∏è Asset .exe non trouv√©, utilisation du nom par d√©faut"
            ASSET_NAME="Nexus-$VERSION_NUMBER.exe"
            ASSET_URL="https://github.com/$REPO/releases/download/$VERSION/$ASSET_NAME"
            echo "asset_exists=false" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ Asset trouv√©: $ASSET_NAME"
            echo "asset_exists=true" >> $GITHUB_OUTPUT
          fi
          
          echo "download_url=$ASSET_URL" >> $GITHUB_OUTPUT
          echo "asset_name=$ASSET_NAME" >> $GITHUB_OUTPUT

      - name: Prepare Discord Payload
        id: payload
        env:
          VERSION: ${{ steps.version.outputs.version }}
          VERSION_NUMBER: ${{ steps.version.outputs.version_number }}
          ASSET_URL: ${{ steps.asset.outputs.download_url }}
          ASSET_EXISTS: ${{ steps.asset.outputs.asset_exists }}
          TRUNCATED: ${{ steps.changelog.outputs.truncated }}
        run: |
          # Lire les fichiers
          CHANGELOG_RAW=$(cat changelog_short.txt)
          SUMMARY_RAW=$(cat summary.txt)
          
          # Pr√©parer le message de t√©l√©chargement
          if [ "$ASSET_EXISTS" = "true" ]; then
            DOWNLOAD_MSG="**Windows** : [üíæ T√©l√©charger l'installateur]($ASSET_URL)"
          else
            DOWNLOAD_MSG="**Windows** : ‚è≥ L'installateur sera disponible sous peu\n[üì¶ Voir la page de release](https://github.com/Rory-Mercury-91/Le-Nexus/releases/tag/$VERSION)"
          fi
          
          # Ajouter un lien vers le changelog complet si tronqu√©
          if [ "$TRUNCATED" = "true" ]; then
            CHANGELOG_RAW="${CHANGELOG_RAW}\n\n_[üìñ Voir le changelog complet](https://github.com/Rory-Mercury-91/Le-Nexus/blob/main/CHANGELOG.md)_"
          fi
          
          # Construire le JSON avec jq
          jq -n \
            --arg username "Nexus Release Bot" \
            --arg avatar "https://github.com/Rory-Mercury-91.png" \
            --arg version "$VERSION" \
            --arg version_num "$VERSION_NUMBER" \
            --arg summary "$SUMMARY_RAW" \
            --arg changelog "$CHANGELOG_RAW" \
            --arg download "$DOWNLOAD_MSG" \
            --arg timestamp "$(date -u +%Y-%m-%dT%H:%M:%S.000Z)" \
            '{
              "username": $username,
              "avatar_url": $avatar,
              "embeds": [{
                "title": ("üöÄ Nexus " + $version + " - Nouvelle Version Disponible !"),
                "description": "**Une mise √† jour importante de Nexus est maintenant disponible.**\n\n",
                "color": 5814783,
                "fields": [
                  {
                    "name": "‚ú® Points Cl√©s de cette Version",
                    "value": $summary,
                    "inline": false
                  },
                  {
                    "name": "üìã Changements Complets",
                    "value": $changelog,
                    "inline": false
                  },
                  {
                    "name": "‚¨áÔ∏è T√©l√©chargements",
                    "value": $download,
                    "inline": false
                  },
                  {
                    "name": "üîó Liens Utiles",
                    "value": ("üì¶ [Page de la Release](https://github.com/Rory-Mercury-91/Le-Nexus/releases/tag/" + $version + ")\nüêõ [Signaler un Bug](https://github.com/Rory-Mercury-91/Le-Nexus/issues)\nüìñ [Documentation](https://github.com/Rory-Mercury-91/Le-Nexus#readme)"),
                    "inline": false
                  }
                ],
                "footer": {
                  "text": ("Nexus v" + $version_num + " ‚Ä¢ Production Ready ‚Ä¢ Merci de votre soutien !"),
                  "icon_url": $avatar
                },
                "timestamp": $timestamp
              }]
            }' > discord_payload.json
          
          echo "‚úÖ Payload Discord pr√©par√©"

      - name: Send Discord Notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL_NEXUS }}
        run: |
          echo "üì§ Envoi de la notification Discord..."
          
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "$DISCORD_WEBHOOK" \
            -H "Content-Type: application/json" \
            -d @discord_payload.json)
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          
          if [ "$HTTP_CODE" -eq 204 ] || [ "$HTTP_CODE" -eq 200 ]; then
            echo "‚úÖ Notification envoy√©e avec succ√®s !"
          else
            echo "‚ùå Erreur lors de l'envoi (HTTP $HTTP_CODE)"
            echo "$RESPONSE" | head -n -1
            exit 1
          fi
