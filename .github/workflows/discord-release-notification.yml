name: Discord Release Notification

on:
  release:
    types: [published, created]
  workflow_run:
    workflows: ["Build and Release"]
    types:
      - completed
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag de la release (ex: v1.0.0)'
        required: true
        default: 'v1.0.0'

jobs:
  notify-discord:
    name: Notify Discord
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Extract Version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
          elif [ "${{ github.event_name }}" = "workflow_run" ]; then
            VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "v1.0.0")
          else
            VERSION="${{ github.event.inputs.tag_name }}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          VERSION_NUM=$(echo "$VERSION" | sed 's/^v//')
          echo "version_number=$VERSION_NUM" >> $GITHUB_OUTPUT

      - name: Extract Changelog
        id: changelog
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          VERSION_NUM=$(echo "$VERSION" | sed 's/^v//')
          
          if [ ! -f CHANGELOG.md ]; then
            echo "Contenu disponible dans les prochaines releases." > changelog_extract.txt
          else
            awk -v ver="$VERSION_NUM" '
            BEGIN { started=0 }
            /^## [0-9]{4}-[0-9]{2}-[0-9]{2}/ {
              if (match($0, /v?([0-9]+\.[0-9]+\.[0-9]+)/, arr)) {
                if (arr[1] == ver) {
                  started = 1
                  next
                } else if (started) {
                  exit
                }
              }
            }
            started { print }
            ' CHANGELOG.md > changelog_extract.txt
          fi
          
          if [ ! -s changelog_extract.txt ]; then
            echo "Contenu disponible dans les prochaines releases." > changelog_extract.txt
          fi
          
          head -c 1000 changelog_extract.txt > changelog_short.txt

      - name: Get Release Notes
        id: release_notes
        if: github.event_name == 'release'
        run: |
          # Utiliser les notes de release GitHub si disponibles
          if [ -n "${{ github.event.release.body }}" ]; then
            echo "${{ github.event.release.body }}" | head -c 1000 > release_notes.txt
          else
            echo "Aucune note de release disponible." > release_notes.txt
          fi

      - name: Send Discord Notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL_NEXUS }}
          VERSION: ${{ steps.version.outputs.version }}
          VERSION_NUMBER: ${{ steps.version.outputs.version_number }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
        run: |
          if [ -f changelog_short.txt ]; then
            CHANGELOG_RAW=$(cat changelog_short.txt)
          else
            CHANGELOG_RAW=""
          fi
          
          if [ -f changelog_extract.txt ]; then
            SUMMARY_RAW=$(awk 'BEGIN { count=0 } /^### / { if (count < 3) { count++; print "â€¢ " $0 } }' changelog_extract.txt | sed 's/### //')
            if [ -z "$SUMMARY_RAW" ]; then
              SUMMARY_RAW="â€¢ Nouvelle version disponible"
            fi
          else
            SUMMARY_RAW="â€¢ Nouvelle version disponible"
          fi
          
          if [ -f release_notes.txt ]; then
            RELEASE_NOTES=$(cat release_notes.txt)
          else
            RELEASE_NOTES="Nouvelle version de Nexus disponible !"
          fi
          
          # Construire le JSON avec jq pour Ã©chappement correct
          jq -n \
            --arg username "Nexus Release Bot" \
            --arg avatar "https://github.com/$REPO_OWNER.png" \
            --arg version "$VERSION" \
            --arg version_num "$VERSION_NUMBER" \
            --arg summary "$SUMMARY_RAW" \
            --arg changelog "$CHANGELOG_RAW" \
            --arg release_notes "$RELEASE_NOTES" \
            --arg repo_owner "$REPO_OWNER" \
            --arg repo_name "$REPO_NAME" \
            --arg timestamp "$(date -u +%Y-%m-%dT%H:%M:%S.000Z)" \
            '{
              "username": $username,
              "avatar_url": $avatar,
              "embeds": [{
                "title": ("ðŸš€ Nexus " + $version + " - Nouvelle Version Disponible !"),
                "description": ("**Une mise Ã  jour importante de Nexus est maintenant disponible.**\n\n" + $release_notes),
                "color": 5814783,
                "fields": [
                  {
                    "name": "âœ¨ Points ClÃ©s de cette Version",
                    "value": (if $summary != "" then $summary else "â€¢ Nouvelle version disponible" end),
                    "inline": false
                  },
                  {
                    "name": "ðŸ“ Changements Complets",
                    "value": (if $changelog != "" then $changelog else "Contenu disponible dans les prochaines releases." end),
                    "inline": false
                  },
                  {
                    "name": "â¬‡ï¸ TÃ©lÃ©chargements",
                    "value": ("**Windows** : [ðŸ’¾ TÃ©lÃ©charger l'installateur](https://github.com/" + $repo_owner + "/" + $repo_name + "/releases/download/" + $version + "/Nexus%20Setup%20" + $version_num + ".exe)"),
                    "inline": false
                  },
                  {
                    "name": "ðŸ”— Liens Utiles",
                    "value": ("ðŸ“¦ [Page de la Release](https://github.com/" + $repo_owner + "/" + $repo_name + "/releases/tag/" + $version + ")\nðŸ› [Signaler un Bug](https://github.com/" + $repo_owner + "/" + $repo_name + "/issues)"),
                    "inline": false
                  }
                ],
                "footer": {
                  "text": ("Nexus v" + $version_num + " â€¢ Production Ready â€¢ Merci de votre soutien !"),
                  "icon_url": $avatar
                },
                "timestamp": $timestamp
              }]
            }' > discord_payload.json
          
          # Envoyer le JSON Ã  Discord
          curl -X POST "$DISCORD_WEBHOOK" \
            -H "Content-Type: application/json" \
            -d @discord_payload.json
