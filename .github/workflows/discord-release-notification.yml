name: Discord Release Notification

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag de la release (ex: v1.0.0)'
        required: true
        default: 'v1.0.0'

jobs:
  notify-discord:
    name: Notify Discord
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Extract Version
        id: version
        run: |
          # Utiliser le tag de l'Ã©vÃ©nement release ou l'input manuel
          if [ "${{ github.event_name }}" == "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
          else
            VERSION="${{ github.event.inputs.tag_name }}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "version_number=${VERSION#v}" >> $GITHUB_OUTPUT

      - name: Fetch Release Asset
        id: asset
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          VERSION_NUMBER="${{ steps.version.outputs.version_number }}"
          REPO="${{ github.repository }}"
          
          RESPONSE=$(curl -s \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            "https://api.github.com/repos/$REPO/releases/tags/$VERSION")
          
          ASSET_URL=$(echo "$RESPONSE" | jq -r '.assets[]? | select(.name | endswith(".exe")) | .browser_download_url' | head -n 1)
          ASSET_NAME=$(echo "$RESPONSE" | jq -r '.assets[]? | select(.name | endswith(".exe")) | .name' | head -n 1)
          
          if [ -z "$ASSET_URL" ] || [ "$ASSET_URL" = "null" ]; then
            ASSET_NAME="Nexus-$VERSION_NUMBER.exe"
            ENCODED_NAME=$ASSET_NAME
            ASSET_URL="https://github.com/$REPO/releases/download/$VERSION/$ENCODED_NAME"
          fi
          
          echo "download_url=$ASSET_URL" >> $GITHUB_OUTPUT
          echo "asset_name=$ASSET_NAME" >> $GITHUB_OUTPUT
          echo "Asset dÃ©tectÃ©: $ASSET_NAME -> $ASSET_URL"

      - name: Send Discord Notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL_NEXUS }}
          VERSION: ${{ steps.version.outputs.version }}
          VERSION_NUMBER: ${{ steps.version.outputs.version_number }}
          ASSET_URL: ${{ steps.asset.outputs.download_url }}
        run: |
          echo "ðŸ“¤ Envoi de la notification Discord..."
          
          # Construire le JSON avec jq pour Ã©chappement correct
          jq -n \
            --arg username "Nexus Release Bot" \
            --arg avatar "https://github.com/Rory-Mercury-91.png" \
            --arg version "$VERSION" \
            --arg version_num "$VERSION_NUMBER" \
            --arg asset_url "$ASSET_URL" \
            --arg timestamp "$(date -u +%Y-%m-%dT%H:%M:%S.000Z)" \
            '{
              "username": $username,
              "avatar_url": $avatar,
              "embeds": [{
                "title": ("ðŸš€ Nexus " + $version + " - Nouvelle Version Disponible !"),
                "description": "**Une nouvelle version de Nexus est maintenant disponible.**\n\nConsultez la [page de release](https://github.com/Rory-Mercury-91/Le-Nexus/releases/tag/" + $version + ") pour plus de dÃ©tails.",
                "color": 5814783,
                "fields": [
                  {
                    "name": "â¬‡ï¸ TÃ©lÃ©chargements",
                    "value": ("**Windows** : [ðŸ’¾ TÃ©lÃ©charger l'\''installateur](" + $asset_url + ")"),
                    "inline": false
                  },
                  {
                    "name": "ðŸ”— Liens Utiles",
                    "value": ("ðŸ“¦ [Page de la Release](https://github.com/Rory-Mercury-91/Le-Nexus/releases/tag/" + $version + ")\nðŸ› [Signaler un Bug](https://github.com/Rory-Mercury-91/Le-Nexus/issues)"),
                    "inline": false
                  }
                ],
                "footer": {
                  "text": ("Nexus v" + $version_num + " â€¢ Production Ready â€¢ Merci de votre soutien !"),
                  "icon_url": $avatar
                },
                "timestamp": $timestamp
              }]
            }' > discord_payload.json
          
          # Valider le JSON avant l'envoi
          if ! jq empty discord_payload.json 2>/dev/null; then
            echo "âŒ Erreur : JSON invalide"
            cat discord_payload.json
            exit 1
          fi
          
          # Afficher le payload pour debug
          echo "ðŸ“‹ Payload JSON gÃ©nÃ©rÃ© :"
          cat discord_payload.json | jq .
          
          # Envoyer le JSON Ã  Discord avec gestion d'erreur
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "$DISCORD_WEBHOOK" \
            -H "Content-Type: application/json" \
            -d @discord_payload.json)
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n -1)
          
          if [ "$HTTP_CODE" -eq 204 ] || [ "$HTTP_CODE" -eq 200 ]; then
            echo "âœ… Notification envoyÃ©e avec succÃ¨s !"
          else
            echo "âŒ Erreur lors de l'envoi (HTTP $HTTP_CODE)"
            echo "RÃ©ponse Discord :"
            echo "$BODY" | jq . 2>/dev/null || echo "$BODY"
            exit 1
          fi
